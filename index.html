<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iquen Messenger</title>
    <link rel="icon" type="image/png" href="Logo/logo.png">
    <style>
        :root {
            /* Palette */
            --bg-dark: #09090b;
            --glass-surface: rgba(20, 20, 25, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.03);
            
            /* Text */
            --text-primary: #ececf1;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;

            /* Accent */
            --accent-color: #a855f7; 
            --accent-glow: rgba(168, 85, 247, 0.3);
            --msg-sent-bg: linear-gradient(135deg, #a855f7 0%, #7e22ce 100%);
            
            /* Status */
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --status-read: #60a5fa;
            --unread-marker: #d946ef;

            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --radius-xl: 24px;
            --radius-lg: 16px;
            --radius-md: 12px;
        }

        [data-theme="light"] {
            --bg-dark: #f3f4f6;
            --glass-surface: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(0, 0, 0, 0.06);
            --glass-highlight: rgba(255, 255, 255, 0.5);
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-muted: #9ca3af;
            --accent-glow: rgba(168, 85, 247, 0.15);
            --status-read: #3b82f6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Ambient Background */
        .ambient-bg {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: 
                radial-gradient(circle at 15% 50%, rgba(168, 85, 247, 0.15), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(59, 130, 246, 0.15), transparent 25%);
            z-index: -1; filter: blur(60px);
            animation: bgPulse 10s ease-in-out infinite alternate;
        }
        @keyframes bgPulse { 0% { opacity: 0.8; } 100% { opacity: 1; } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.3); border-radius: 10px; }

        /* CUSTOM NOTIFICATIONS (TOASTS) */
        #notification-area {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 10000; display: flex; flex-direction: column; gap: 10px;
            pointer-events: none;
        }
        .toast {
            background: rgba(20, 20, 25, 0.9); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); padding: 12px 20px;
            border-radius: var(--radius-md); color: white; font-size: 0.9rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 10px;
            animation: slideDownFade 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 300px; justify-content: center;
        }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.info { border-left: 4px solid var(--accent-color); }
        @keyframes slideDownFade { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* CUSTOM CONFIRM MODAL */
        #confirm-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 9999;
            justify-content: center; align-items: center;
        }
        .confirm-box {
            background: var(--bg-dark); border: 1px solid var(--glass-border);
            padding: 25px; border-radius: var(--radius-lg); width: 320px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: scaleIn 0.2s ease;
        }
        .confirm-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 10px; }
        .confirm-text { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px; }
        .confirm-actions { display: flex; gap: 10px; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* AUTH SCREEN */
        #auth-screen { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; position: relative; z-index: 10; }
        .auth-card {
            background: var(--glass-surface); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); padding: 3rem; border-radius: var(--radius-xl);
            width: 400px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: floatUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes floatUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* LOGO STYLES (UPDATED) */
        .auth-logo {
            width: 150px; /* Increased size */
            height: 150px;
            object-fit: contain;
            margin-bottom: 25px;
            border-radius: 25px;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3)); /* Added glow/shadow */
        }
        
        input[type="text"], input[type="password"] {
            width: 100%; padding: 14px 16px; margin-bottom: 12px; background: rgba(0, 0, 0, 0.1);
            border: 1px solid var(--glass-border); border-radius: var(--radius-md); color: var(--text-primary); outline: none; transition: 0.2s;
        }
        [data-theme="light"] input[type="text"], [data-theme="light"] input[type="password"] { background: rgba(255, 255, 255, 0.5); }
        input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-glow); }
        
        .checkbox-wrapper { display: flex; align-items: center; justify-content: flex-start; gap: 10px; margin-bottom: 15px; margin-top: 5px; }
        .checkbox-wrapper input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent-color); cursor: pointer; }
        .checkbox-wrapper label { font-size: 0.9rem; color: var(--text-secondary); cursor: pointer; user-select: none; }

        button {
            width: 100%; padding: 14px; margin-top: 10px; background: var(--accent-color);
            color: white; border: none; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 12px var(--accent-glow);
        }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        button:active { transform: scale(0.98); }
        .secondary-btn { background: transparent; color: var(--text-secondary); box-shadow: none; border: 1px solid var(--glass-border); }
        .secondary-btn:hover { background: var(--glass-highlight); color: var(--text-primary); }

        /* APP CONTAINER */
        #app-container {
            display: none; width: 95vw; height: 92vh; background: var(--glass-surface);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); border-radius: var(--radius-xl);
            box-shadow: 0 25px 100px -20px rgba(0,0,0,0.3); overflow: hidden; position: relative; z-index: 5;
        }

        /* SIDEBAR */
        .sidebar { width: 320px; border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; background: rgba(0,0,0,0.02); }
        .sidebar-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .user-mini { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 8px 12px; border-radius: var(--radius-md); transition: 0.2s; }
        .user-mini:hover { background: var(--glass-highlight); }
        .user-mini img { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-color); }
        .dev-badge { background: #facc15; color: black; font-size: 0.6rem; padding: 2px 5px; border-radius: 4px; font-weight: bold; margin-left: 5px; vertical-align: middle; }
        
        .icon-btn { width: 36px; height: 36px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; background: var(--glass-highlight); color: var(--text-secondary); cursor: pointer; transition: 0.2s; }
        .icon-btn:hover { background: var(--accent-color); color: white; }
        
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { display: flex; align-items: center; gap: 14px; padding: 12px 14px; border-radius: var(--radius-md); cursor: pointer; transition: 0.2s; margin-bottom: 4px; position: relative; }
        .chat-item:hover { background: var(--glass-highlight); }
        .chat-item.active { background: rgba(168, 85, 247, 0.1); border: 1px solid var(--accent-glow); }
        .chat-info { flex: 1; min-width: 0; }
        .chat-info h4 { font-size: 0.95rem; margin-bottom: 3px; font-weight: 500; display: flex; justify-content: space-between; }
        .chat-info p { font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .unread-dot { width: 10px; height: 10px; background: var(--unread-marker); border-radius: 50%; box-shadow: 0 0 10px var(--unread-marker); margin-left: auto; flex-shrink: 0; }

        /* CHAT AREA */
        .chat-area { flex: 1; display: flex; flex-direction: column; position: relative; background: radial-gradient(circle at 50% 50%, rgba(0,0,0,0.01), transparent); }
        .chat-header { height: 70px; padding: 0 25px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--glass-border); background: rgba(var(--bg-dark), 0.3); }
        .chat-header-info { display: flex; align-items: center; gap: 15px; }
        .chat-header-actions { display: flex; gap: 10px; }

        .messages-container { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 70%; padding: 12px 18px; border-radius: 20px; font-size: 0.95rem; line-height: 1.5; position: relative; animation: slideIn 0.3s ease; word-wrap: break-word; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-own { align-self: flex-end; background: var(--msg-sent-bg); color: white; border-bottom-right-radius: 4px; box-shadow: 0 4px 15px var(--accent-glow); }
        .msg-other { align-self: flex-start; background: var(--glass-highlight); border: 1px solid var(--glass-border); color: var(--text-primary); border-bottom-left-radius: 4px; }
        .msg-system { align-self: center; background: rgba(255,255,255,0.1); border-radius: 20px; font-size: 0.8rem; color: var(--text-secondary); padding: 5px 15px; border: 1px solid var(--glass-border); text-align: center; }
        .msg-sender-name { font-size: 0.75rem; color: var(--accent-color); margin-bottom: 4px; font-weight: 600; }

        .msg-footer { display: flex; align-items: flex-end; justify-content: flex-end; gap: 5px; margin-top: 5px; }
        .msg-time { font-size: 0.7rem; opacity: 0.7; }
        .msg-status { display: flex; align-items: center; }
        .msg-status svg { width: 14px; height: 14px; }
        .status-read { color: var(--status-read) !important; }

        .msg-media { max-width: 100%; border-radius: 12px; margin-bottom: 5px; }
        .video-circle { width: 160px; height: 160px; border-radius: 50%; object-fit: cover; border: 3px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        
        /* Input */
        .input-area { padding: 20px 25px; border-top: 1px solid var(--glass-border); display: flex; gap: 12px; align-items: center; }
        .attach-btn { width: 44px; height: 44px; border-radius: 12px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; background: var(--glass-highlight); color: var(--text-secondary); border: 1px solid var(--glass-border); }
        .attach-btn:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .send-btn { background: var(--accent-color); color: white; border: none; box-shadow: 0 4px 15px var(--accent-glow); }
        .recording-pulse { animation: pulseRed 1.5s infinite; background: var(--danger) !important; color: white !important; border-color: var(--danger) !important; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* CALL OVERLAY */
        #call-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(20px);
        }
        .call-avatar { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent-color); margin-bottom: 20px; animation: pulseCall 2s infinite; }
        @keyframes pulseCall { 0% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.4); } 70% { box-shadow: 0 0 0 30px rgba(168, 85, 247, 0); } 100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); } }
        .call-actions { display: flex; gap: 30px; margin-top: 50px; }
        .call-btn { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; color: white; font-size: 1.5rem; transition: transform 0.2s; }
        .call-btn:hover { transform: scale(1.1); }
        .btn-decline { background: var(--danger); }
        .btn-accept { background: var(--success); }
        .btn-mute { background: var(--text-secondary); font-size: 1.2rem; }

        /* SETTINGS & DEV */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { width: 900px; height: 650px; background: linear-gradient(145deg, var(--bg-dark), #101014); border: 1px solid var(--glass-border); border-radius: var(--radius-xl); display: flex; overflow: hidden; box-shadow: 0 50px 100px -20px rgba(0,0,0,0.5); }
        .settings-nav { width: 240px; background: rgba(0,0,0,0.2); padding: 30px 15px; border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 8px; }
        .nav-item { padding: 12px 16px; border-radius: var(--radius-md); text-align: left; background: transparent; color: var(--text-muted); box-shadow: none; margin: 0; font-weight: 500; cursor: pointer; border: none; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
        .nav-item.active { background: var(--glass-highlight); color: var(--accent-color); font-weight: 600; }
        
        .settings-body { flex: 1; padding: 40px; overflow-y: auto; position: relative; }
        .tab-pane { display: none; animation: fadeIn 0.3s ease; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .avatar-lg { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent-color); }
        .color-option { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; display: inline-block; margin-right: 10px; }
        .color-option.active { border-color: white; transform: scale(1.1); }
        .close-modal-abs { position: absolute; top: 20px; right: 20px; }

        /* Dev Table */
        .dev-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        .dev-table th { text-align: left; color: var(--text-muted); padding: 10px; border-bottom: 1px solid var(--glass-border); }
        .dev-table td { padding: 10px; border-bottom: 1px solid var(--glass-border); vertical-align: middle; }
        .dev-action-btn { padding: 5px 10px; font-size: 0.75rem; margin-right: 5px; width: auto; display: inline-block; }
        .banned-row { opacity: 0.5; text-decoration: line-through; }
        .spy-toggle { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,0,0.1); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,0,0.3); color: #facc15; margin-bottom: 20px; }

        /* Group Creation */
        .group-create-step { display: none; flex-direction: column; height: 100%; }
        .group-create-step.active { display: flex; }
        .user-select-list { flex: 1; overflow-y: auto; margin-bottom: 15px; }
        .user-select-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--glass-border); cursor: pointer; }
        .user-select-item input { width: 20px; height: 20px; }

        /* Utils */
        .hidden { display: none !important; }
        .w-auto { width: auto !important; display: inline-block; margin-right: 10px; }
        .user-search-item { padding: 15px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        #flash-bang-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 9999; transition: opacity 0.1s; }
        .flash-active { opacity: 1 !important; }
    </style>
</head>
<body>

    <div class="ambient-bg"></div>
    <div id="flash-bang-overlay"></div>
    <div id="notification-area"></div>

    <!-- Confirm Modal -->
    <div id="confirm-modal">
        <div class="confirm-box">
            <div class="confirm-title" id="confirm-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
            <div class="confirm-text" id="confirm-text">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</div>
            <div class="confirm-actions">
                <button class="secondary-btn" onclick="ui.closeConfirm()">–û—Ç–º–µ–Ω–∞</button>
                <button id="confirm-btn-yes">–î–∞</button>
            </div>
        </div>
    </div>

    <!-- Call Overlay -->
    <div id="call-overlay">
        <img id="call-target-avatar" src="" class="call-avatar">
        <h2 id="call-status" style="margin-bottom: 10px;">–ó–≤–æ–Ω–æ–∫...</h2>
        <h3 id="call-target-name" style="color: var(--text-secondary);">User</h3>
        <div id="call-actions-container" class="call-actions"></div>
    </div>

    <!-- Auth -->
    <div id="auth-screen">
        <div class="auth-card">
            <!-- LOGO: Replaces H1 -->
            <img src="Logo/logo.png" alt="Iquen" class="auth-logo" onerror="this.style.display='none'">
            
            <div id="auth-forms">
                <div id="login-form">
                    <input type="text" id="login-username" placeholder="–õ–æ–≥–∏–Ω">
                    <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="remember-me">
                        <label for="remember-me">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
                    </div>
                    <button onclick="auth.login()">–í–æ–π—Ç–∏</button>
                    <button class="secondary-btn" onclick="ui.toggleAuthMode()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                </div>
                <div id="register-form" class="hidden">
                    <input type="text" id="reg-name" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è">
                    <input type="text" id="reg-username" placeholder="–õ–æ–≥–∏–Ω">
                    <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å">
                    <button onclick="auth.register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    <button class="secondary-btn" onclick="ui.toggleAuthMode()">–í—Ö–æ–¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- App -->
    <div id="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-mini" onclick="ui.openSettings()">
                    <img id="current-user-avatar" src="">
                    <div>
                        <span id="current-user-name">User</span>
                        <span id="dev-badge-main" class="dev-badge hidden">DEV</span>
                    </div>
                </div>
                <button class="icon-btn" onclick="ui.openNewChatModal()">+</button>
            </div>
            <div class="chat-list" id="chat-list"></div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area" id="chat-view">
            <div class="chat-header">
                <div class="chat-header-info">
                    <img src="" class="avatar-lg hidden" id="chat-header-avatar" style="width: 40px; height: 40px;">
                    <div>
                        <h3 id="chat-header-name">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                        <span id="chat-header-status" style="font-size: 0.8rem; opacity: 0.7;"></span>
                    </div>
                </div>
                <div class="chat-header-actions hidden" id="chat-actions">
                    <button class="icon-btn" onclick="callSystem.startCall('audio')">üìû</button>
                    <button class="icon-btn" onclick="callSystem.startCall('video')">üìπ</button>
                </div>
            </div>
            
            <div class="messages-container" id="messages-container"></div>

            <div class="input-area hidden" id="input-area">
                <input type="file" id="file-input" hidden onchange="chat.handleFileUpload(this)">
                <button class="attach-btn" onclick="document.getElementById('file-input').click()">üìé</button>
                <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key === 'Enter') chat.sendMessage()" autocomplete="off">
                <button id="record-btn" class="attach-btn" onclick="chat.toggleRecording()">üé§</button>
                <button class="attach-btn send-btn" onclick="chat.sendMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="settings-nav">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <button class="nav-item active" onclick="ui.switchTab('tab-profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
                <button class="nav-item" onclick="ui.switchTab('tab-appearance')">üé® –í–∏–¥</button>
                <button class="nav-item" onclick="ui.switchTab('tab-data')">üíæ –î–∞–Ω–Ω—ã–µ</button>
                <button class="nav-item" onclick="ui.switchTab('tab-lab')">üß™ Lab</button>
                <button class="nav-item hidden" id="tab-btn-dev" onclick="ui.switchTab('tab-dev')">‚ö° Dev Tools</button>
            </div>
            <div class="settings-body">
                <button class="icon-btn close-modal-abs" onclick="ui.closeModal('settings-modal')">‚úï</button>
                <div id="tab-profile" class="tab-pane active">
                    <h3>–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                    <div style="display:flex;align-items:center;gap:20px;margin-bottom:20px;">
                        <img id="setting-avatar-preview" src="" class="avatar-lg">
                        <button class="w-auto" onclick="document.getElementById('avatar-file-input').click()">–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
                        <input type="file" id="avatar-file-input" hidden accept="image/*" onchange="settings.handleAvatarUpload(this)">
                    </div>
                    <label>–ò–º—è</label><input type="text" id="edit-name">
                    <label>–°—Ç–∞—Ç—É—Å</label><input type="text" id="edit-status">
                    <button onclick="settings.saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="secondary-btn" style="margin-top:20px; color:var(--danger); border-color:rgba(239,68,68,0.3);" onclick="auth.logout()">–í—ã–π—Ç–∏</button>
                </div>
                <div id="tab-appearance" class="tab-pane">
                    <h3>–¢–µ–º–∞</h3>
                    <button class="secondary-btn w-auto" onclick="settings.toggleTheme()">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É</button>
                    <h3 style="margin-top:20px;">–ê–∫—Ü–µ–Ω—Ç</h3>
                    <div>
                        <div class="color-option" style="background:#a855f7;" onclick="settings.setAccent('#a855f7')"></div>
                        <div class="color-option" style="background:#3b82f6;" onclick="settings.setAccent('#3b82f6')"></div>
                        <div class="color-option" style="background:#10b981;" onclick="settings.setAccent('#10b981')"></div>
                        <div class="color-option" style="background:#f59e0b;" onclick="settings.setAccent('#f59e0b')"></div>
                        <div class="color-option" style="background:#ec4899;" onclick="settings.setAccent('#ec4899')"></div>
                    </div>
                    <h3 style="margin-top:20px;">–§–æ–Ω</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="secondary-btn w-auto" onclick="document.getElementById('bg-file-input').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
                        <span id="bg-file-name" style="font-size: 0.8rem; color: var(--text-secondary);"></span>
                    </div>
                    <input type="file" id="bg-file-input" hidden accept="image/*" onchange="settings.handleBgUpload(this)">
                </div>
                <div id="tab-data" class="tab-pane">
                    <h3>–ß–∞—Ç—ã</h3>
                    <button class="secondary-btn" onclick="ui.confirmAction('–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É?', '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.', chat.clearAllMessages)">–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π —á–∞—Ç</button>
                </div>
                <div id="tab-lab" class="tab-pane">
                    <h3>–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã</h3>
                    <button style="background:#fff;color:#000;" onclick="effects.flashBang()">FLASH-BANG</button>
                </div>
                <div id="tab-dev" class="tab-pane">
                    <h3 style="color:#facc15;">MAHITO GOD PANEL</h3>
                    <div class="spy-toggle"><span>üïµÔ∏è <b>Spy Mode</b></span><input type="checkbox" id="spy-mode-toggle" onchange="devTools.toggleSpy(this.checked)"></div>
                    <div style="margin-bottom: 20px;">
                        <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h4>
                        <table class="dev-table"><thead><tr><th>User</th><th>Status</th><th>Actions</th></tr></thead><tbody id="dev-user-list"></tbody></table>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h4>–ì–ª–æ–±–∞–ª—å–Ω–æ–µ –≤–µ—â–∞–Ω–∏–µ</h4>
                        <input type="text" id="broadcast-input" placeholder="–°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º...">
                        <button class="w-auto" onclick="devTools.broadcast()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º</button>
                    </div>
                    <div>
                        <h4>–ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö</h4>
                        <button class="secondary-btn w-auto" onclick="devTools.exportDB()">Backup JSON</button>
                        <button class="secondary-btn w-auto" onclick="document.getElementById('import-db').click()">Import Backup</button>
                        <input type="file" id="import-db" hidden onchange="devTools.importDB(this)">
                        <button class="secondary-btn w-auto" style="border-color:red;color:red;" onclick="ui.confirmAction('–°—Ç–µ—Ä–µ—Ç—å –≤—Å—ë?','–≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ.',devTools.wipe)">WIPE ALL DATA</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Chat / Group Modal -->
    <div id="new-chat-modal" class="modal">
        <div class="modal-content" style="width: 450px; height: 550px; flex-direction: column;">
            <div style="padding: 20px; border-bottom: 1px solid var(--glass-border); display:flex; justify-content:space-between; align-items:center;">
                <h2 id="new-chat-title">–ù–æ–≤—ã–π —á–∞—Ç</h2>
                <button class="icon-btn" onclick="ui.closeModal('new-chat-modal')">‚úï</button>
            </div>
            
            <!-- Default List View -->
            <div id="new-chat-default" class="group-create-step active">
                <button class="secondary-btn" style="margin: 10px 20px; width: auto;" onclick="ui.showGroupCreate()">üë• –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
                <div id="user-list" style="flex:1; overflow-y:auto;"></div>
            </div>

            <!-- Create Group View -->
            <div id="new-chat-group" class="group-create-step">
                <div style="padding: 20px;">
                    <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                        <img id="new-group-avatar-preview" src="https://ui-avatars.com/api/?name=Group&background=random" class="avatar-lg" style="width:60px; height:60px;">
                        <button class="secondary-btn w-auto" style="margin:0;" onclick="document.getElementById('group-avatar-input').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
                        <input type="file" id="group-avatar-input" hidden accept="image/*" onchange="chat.handleGroupAvatarUpload(this)">
                    </div>
                    <input type="text" id="group-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
                </div>
                <div id="group-user-list" class="user-select-list"></div>
                <div style="padding: 20px; border-top: 1px solid var(--glass-border);">
                    <button onclick="chat.createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
                    <button class="secondary-btn" onclick="ui.showDefaultCreate()">–ù–∞–∑–∞–¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /** IQUEN CORE v12.0 - LOGO UPDATED */

        const DB_USERS = 'iquen_users';
        const DB_CHATS = 'iquen_chats';
        const DB_SESSION = 'iquen_session';
        const DB_CALL_SIGNAL = 'iquen_call_signal';

        let currentUser = null;
        let activeChatId = null;
        let isSpyMode = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let tempGroupAvatar = null;

        // --- NOTIFICATION SYSTEM ---
        const notify = {
            show: (msg, type = 'info') => {
                const area = document.getElementById('notification-area');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerText = msg;
                area.appendChild(toast);
                setTimeout(() => { toast.style.animation = 'fadeOut 0.3s forwards'; setTimeout(() => toast.remove(), 300); }, 3000);
            },
            success: (msg) => notify.show(msg, 'success'), error: (msg) => notify.show(msg, 'error'), info: (msg) => notify.show(msg, 'info')
        };

        const soundManager = { playPop: () => { const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg"); audio.volume = 0.5; audio.play().catch(e => {}); } };

        const db = {
            getUsers: () => JSON.parse(localStorage.getItem(DB_USERS) || '[]'),
            saveUsers: (users) => localStorage.setItem(DB_USERS, JSON.stringify(users)),
            getChats: () => JSON.parse(localStorage.getItem(DB_CHATS) || '[]'),
            saveChats: (chats) => localStorage.setItem(DB_CHATS, JSON.stringify(chats)),
            getSession: () => localStorage.getItem(DB_SESSION) || sessionStorage.getItem(DB_SESSION),
            setSession: (id, remember) => { if (remember) { localStorage.setItem(DB_SESSION, id); sessionStorage.removeItem(DB_SESSION); } else { sessionStorage.setItem(DB_SESSION, id); localStorage.removeItem(DB_SESSION); } },
            clearSession: () => { localStorage.removeItem(DB_SESSION); sessionStorage.removeItem(DB_SESSION); },
            sendSignal: (signal) => { signal.timestamp = Date.now(); localStorage.setItem(DB_CALL_SIGNAL, JSON.stringify(signal)); }
        };

        const auth = {
            init: () => {
                let users = db.getUsers();
                if (users.find(u => u.username === 'MahitoTT')) {
                    users = users.filter(u => u.username !== 'MahitoTT');
                    db.saveUsers(users);
                }
                if (!users.find(u => u.username === 'MahitoDev')) {
                    users.push({ id: 'dev_mahito_001', name: 'Mahito', username: 'MahitoDev', password: '22842', avatar: 'https://ui-avatars.com/api/?name=Mahito+Dev&background=facc15&color=000', status: 'System Creator', isDev: true, settings: { theme: 'dark', accent: '#facc15', bg: '' } });
                    db.saveUsers(users);
                }
                const sessionId = db.getSession();
                if (sessionId) {
                    currentUser = users.find(u => u.id === sessionId);
                    if (currentUser) {
                        if (currentUser.isBanned) { notify.error("–ê–ö–ö–ê–£–ù–¢ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù."); auth.logout(); return; }
                        ui.showApp(); return;
                    }
                }
                ui.showAuth();
            },
            register: () => {
                const name = document.getElementById('reg-name').value;
                const username = document.getElementById('reg-username').value;
                const password = document.getElementById('reg-password').value;
                if (!name || !username || !password) return notify.error('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                const users = db.getUsers();
                if (users.find(u => u.username === username)) return notify.error('–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç');
                const newUser = { id: 'uid_' + Date.now(), name, username, password, avatar: `https://ui-avatars.com/api/?name=${name}&background=random`, status: 'Iquen User', settings: { theme: 'dark', accent: '#a855f7', bg: '' } };
                users.push(newUser); db.saveUsers(users);
                db.setSession(newUser.id, true); currentUser = newUser; ui.showApp();
            },
            login: () => {
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                const remember = document.getElementById('remember-me').checked;
                const users = db.getUsers();
                const user = users.find(u => u.username === username && u.password === password);
                if (user) {
                    if (user.isBanned) return notify.error("–ê–ö–ö–ê–£–ù–¢ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù.");
                    if (user.username === 'MahitoDev' && user.password !== '22842') return notify.error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞');
                    db.setSession(user.id, remember); currentUser = user; ui.showApp();
                } else { notify.error('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); }
            },
            logout: () => { db.clearSession(); location.reload(); }
        };

        const chat = {
            createOrGetChat: (targetId) => {
                let chats = db.getChats();
                let existing = chats.find(c => !c.isGroup && c.participants.includes(currentUser.id) && c.participants.includes(targetId));
                if (existing) chat.openChat(existing.id);
                else {
                    const newChat = { id: 'chat_' + Date.now(), isGroup: false, participants: [currentUser.id, targetId], messages: [], updatedAt: Date.now() };
                    chats.push(newChat); db.saveChats(chats); chat.openChat(newChat.id);
                }
                ui.closeModal('new-chat-modal');
            },
            handleGroupAvatarUpload: (input) => {
                const file = input.files[0]; if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => { tempGroupAvatar = e.target.result; document.getElementById('new-group-avatar-preview').src = tempGroupAvatar; };
                reader.readAsDataURL(file);
            },
            createGroup: () => {
                const name = document.getElementById('group-name-input').value;
                if (!name) return notify.error("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã");
                const checkboxes = document.querySelectorAll('.group-check:checked');
                const selectedIds = Array.from(checkboxes).map(cb => cb.value);
                if (selectedIds.length === 0) return notify.error("–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤");
                selectedIds.push(currentUser.id);
                const newChat = { 
                    id: 'group_' + Date.now(), isGroup: true, name: name, 
                    avatar: tempGroupAvatar || `https://ui-avatars.com/api/?name=${name}&background=random&rounded=true`, 
                    ownerId: currentUser.id, participants: selectedIds, messages: [], updatedAt: Date.now() 
                };
                let chats = db.getChats(); chats.push(newChat); db.saveChats(chats);
                chat.sendSystemMessage(newChat.id, `–ì—Ä—É–ø–ø–∞ "${name}" —Å–æ–∑–¥–∞–Ω–∞`);
                chat.openChat(newChat.id); ui.closeModal('new-chat-modal'); tempGroupAvatar = null;
            },
            openChat: (chatId) => {
                activeChatId = chatId; chat.markMessagesAsRead(chatId); ui.renderChatView(chatId); ui.renderChatList();
                const container = document.getElementById('messages-container'); setTimeout(() => container.scrollTop = container.scrollHeight, 50);
            },
            markMessagesAsRead: (chatId) => {
                let chats = db.getChats(); let c = chats.find(x => x.id === chatId);
                if (c) {
                    let changed = false;
                    c.messages.forEach(m => { if (m.senderId !== currentUser.id && m.status !== 'read') { m.status = 'read'; changed = true; } });
                    if (changed) db.saveChats(chats);
                }
            },
            sendMessage: (type = 'text', content = null) => {
                if (!activeChatId) return;
                const input = document.getElementById('message-input');
                const finalContent = content || input.value;
                if (!finalContent && type === 'text') return;
                let chats = db.getChats(); let idx = chats.findIndex(c => c.id === activeChatId);
                if (idx > -1) {
                    chats[idx].messages.push({ id: 'msg_' + Date.now(), senderId: currentUser.id, type, content: finalContent, timestamp: Date.now(), status: 'delivered' });
                    chats[idx].updatedAt = Date.now(); db.saveChats(chats);
                    if (type === 'text') input.value = '';
                    ui.renderMessages(chats[idx].messages); ui.renderChatList();
                }
            },
            sendSystemMessage: (chatId, text) => {
                let chats = db.getChats(); let idx = chats.findIndex(c => c.id === chatId);
                if(idx > -1) { chats[idx].messages.push({ id: 'sys_' + Date.now(), senderId: 'SYSTEM', type: 'text', content: text, timestamp: Date.now(), status: 'read' }); db.saveChats(chats); }
            },
            handleFileUpload: (input) => {
                const file = input.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => { let type = 'image'; if (file.type.startsWith('video')) type = 'video-circle'; else if (file.type.startsWith('audio')) type = 'audio'; chat.sendMessage(type, e.target.result); }; reader.readAsDataURL(file); input.value = '';
            },
            toggleRecording: async () => {
                const btn = document.getElementById('record-btn');
                if (!isRecording) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream); audioChunks = []; mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                        mediaRecorder.onstop = () => { const blob = new Blob(audioChunks, { type: 'audio/mp3' }); const reader = new FileReader(); reader.readAsDataURL(blob); reader.onloadend = () => chat.sendMessage('audio', reader.result); stream.getTracks().forEach(t => t.stop()); }; mediaRecorder.start(); isRecording = true; btn.classList.add('recording-pulse');
                    } catch (e) { notify.error("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É"); }
                } else { if (mediaRecorder) mediaRecorder.stop(); isRecording = false; btn.classList.remove('recording-pulse'); }
            },
            clearAllMessages: () => { if(!activeChatId) return; let chats = db.getChats(); let c = chats.find(x => x.id === activeChatId); if(c) { c.messages = []; db.saveChats(chats); ui.renderMessages([]); ui.renderChatList(); notify.success("–ß–∞—Ç –æ—á–∏—â–µ–Ω"); ui.closeConfirm(); } }
        };

        const settings = {
            apply: () => { if (!currentUser) return; const s = currentUser.settings; document.documentElement.setAttribute('data-theme', s.theme); document.documentElement.style.setProperty('--accent-color', s.accent); document.documentElement.style.setProperty('--accent-glow', s.accent + '4D'); document.documentElement.style.setProperty('--msg-sent-bg', `linear-gradient(135deg, ${s.accent} 0%, ${s.accent}88 100%)`); const chatArea = document.querySelector('.chat-area'); if (s.bg && s.bg.trim()) { chatArea.style.backgroundImage = `url(${s.bg})`; chatArea.style.backgroundSize = 'cover'; } else { chatArea.style.backgroundImage = 'radial-gradient(circle at 50% 50%, rgba(0,0,0,0.01), transparent)'; } },
            handleAvatarUpload: (input) => { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { document.getElementById('setting-avatar-preview').src = e.target.result; document.getElementById('setting-avatar-preview').dataset.tempSrc = e.target.result; }; reader.readAsDataURL(file); },
            handleBgUpload: (input) => {
                const file = input.files[0]; if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => { settings.setCustomBg(e.target.result); document.getElementById('bg-file-name').innerText = file.name; };
                reader.readAsDataURL(file);
            },
            saveProfile: () => {
                const name = document.getElementById('edit-name').value; const status = document.getElementById('edit-status').value; const preview = document.getElementById('setting-avatar-preview');
                let users = db.getUsers(); let idx = users.findIndex(u => u.id === currentUser.id);
                if (idx > -1) { users[idx].name = name || users[idx].name; users[idx].status = status || users[idx].status; if (preview.dataset.tempSrc) users[idx].avatar = preview.dataset.tempSrc; currentUser = users[idx]; db.saveUsers(users); settings.updateUI(); notify.success('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω'); }
            },
            toggleTheme: () => { let users = db.getUsers(); let idx = users.findIndex(u => u.id === currentUser.id); users[idx].settings.theme = currentUser.settings.theme === 'dark' ? 'light' : 'dark'; currentUser = users[idx]; db.saveUsers(users); settings.apply(); },
            setAccent: (color) => { let users = db.getUsers(); let idx = users.findIndex(u => u.id === currentUser.id); users[idx].settings.accent = color; currentUser = users[idx]; db.saveUsers(users); settings.apply(); },
            setCustomBg: (url) => { let users = db.getUsers(); let idx = users.findIndex(u => u.id === currentUser.id); users[idx].settings.bg = url; currentUser = users[idx]; db.saveUsers(users); settings.apply(); },
            updateUI: () => { document.getElementById('current-user-name').innerText = currentUser.name; document.getElementById('current-user-avatar').src = currentUser.avatar; document.getElementById('edit-name').value = currentUser.name; document.getElementById('edit-status').value = currentUser.status; document.getElementById('setting-avatar-preview').src = currentUser.avatar; document.getElementById('setting-avatar-preview').dataset.tempSrc = ''; if (currentUser.isDev) { document.getElementById('dev-badge-main').classList.remove('hidden'); document.getElementById('tab-btn-dev').classList.remove('hidden'); devTools.renderUserTable(); } else { document.getElementById('dev-badge-main').classList.add('hidden'); document.getElementById('tab-btn-dev').classList.add('hidden'); } }
        };

        const ui = {
            toggleAuthMode: () => { document.getElementById('login-form').classList.toggle('hidden'); document.getElementById('register-form').classList.toggle('hidden'); },
            showAuth: () => { document.getElementById('auth-screen').style.display = 'flex'; document.getElementById('app-container').style.display = 'none'; },
            showApp: () => { document.getElementById('auth-screen').style.display = 'none'; document.getElementById('app-container').style.display = 'flex'; settings.apply(); settings.updateUI(); ui.renderChatList(); },
            confirmAction: (title, text, callback) => {
                document.getElementById('confirm-modal').style.display = 'flex';
                document.getElementById('confirm-title').innerText = title;
                document.getElementById('confirm-text').innerText = text;
                const yesBtn = document.getElementById('confirm-btn-yes');
                yesBtn.onclick = () => { callback(); ui.closeConfirm(); };
            },
            closeConfirm: () => { document.getElementById('confirm-modal').style.display = 'none'; },
            showGroupCreate: () => { document.getElementById('new-chat-default').classList.remove('active'); document.getElementById('new-chat-group').classList.add('active'); document.getElementById('new-chat-title').innerText = "–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã"; const list = document.getElementById('group-user-list'); list.innerHTML = ''; db.getUsers().forEach(u => { if (u.id === currentUser.id) return; const div = document.createElement('div'); div.className = 'user-select-item'; div.onclick = (e) => { if(e.target.type !== 'checkbox') { const cb = div.querySelector('input'); cb.checked = !cb.checked; } }; div.innerHTML = `<div style="display:flex;align-items:center;gap:10px;"><img src="${u.avatar}" style="width:30px;height:30px;border-radius:50%;"><span>${u.name} <small>@${u.username}</small></span></div><input type="checkbox" class="group-check" value="${u.id}">`; list.appendChild(div); }); },
            showDefaultCreate: () => { document.getElementById('new-chat-group').classList.remove('active'); document.getElementById('new-chat-default').classList.add('active'); document.getElementById('new-chat-title').innerText = "–ù–æ–≤—ã–π —á–∞—Ç"; },
            renderChatList: () => {
                const list = document.getElementById('chat-list'); list.innerHTML = '';
                const chats = db.getChats().sort((a,b) => b.updatedAt - a.updatedAt);
                const users = db.getUsers();
                chats.forEach(c => {
                    if (!c.participants.includes(currentUser.id) && !(currentUser.isDev && isSpyMode)) return;
                    let avatar, name, badge = '';
                    if (c.isGroup) { avatar = c.avatar; name = c.name; } 
                    else {
                        let otherId = c.participants.includes(currentUser.id) ? c.participants.find(p => p !== currentUser.id) : c.participants[0];
                        const other = users.find(u => u.id === otherId) || {name:'Unknown',avatar:'',isDev:false};
                        avatar = other.avatar; name = other.name; if(other.isDev) badge = '<span class="dev-badge">DEV</span>';
                    }
                    const last = c.messages.length > 0 ? c.messages[c.messages.length - 1] : null;
                    let preview = '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'; let hasUnread = false;
                    if (last) {
                        if (last.type === 'image') preview = 'üì∑ –§–æ—Ç–æ'; else if (last.type === 'video-circle') preview = '‚ö™ –í–∏–¥–µ–æ'; else if (last.type === 'audio') preview = 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ'; else preview = last.content;
                        if (last.senderId !== currentUser.id && last.status !== 'read') hasUnread = true;
                    }
                    const div = document.createElement('div');
                    div.className = `chat-item ${activeChatId === c.id ? 'active' : ''}`;
                    div.onclick = () => chat.openChat(c.id);
                    div.innerHTML = `<img src="${avatar}" class="avatar-lg" style="width:45px;height:45px;border-width:2px;"><div class="chat-info"><h4><span>${name} ${badge}</span></h4><p>${preview}</p></div>${hasUnread ? '<div class="unread-dot"></div>' : ''}`;
                    list.appendChild(div);
                });
            },
            renderChatView: (chatId) => {
                const c = db.getChats().find(x => x.id === chatId); if (!c) return;
                const users = db.getUsers();
                let avatar, name, status;
                if (c.isGroup) { avatar = c.avatar; name = c.name; status = c.participants.length + ' —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤'; } 
                else {
                    let otherId = c.participants.includes(currentUser.id) ? c.participants.find(p => p !== currentUser.id) : c.participants[0];
                    const other = users.find(u => u.id === otherId); avatar = other.avatar; name = other.name; status = other.status;
                }
                document.getElementById('chat-header-avatar').src = avatar; document.getElementById('chat-header-avatar').classList.remove('hidden');
                document.getElementById('chat-header-name').innerText = name; document.getElementById('chat-header-status').innerText = status;
                document.getElementById('chat-actions').classList.remove('hidden'); document.getElementById('input-area').classList.remove('hidden');
                ui.renderMessages(c.messages);
            },
            renderMessages: (msgs) => {
                const box = document.getElementById('messages-container'); box.innerHTML = '';
                const users = db.getUsers();
                msgs.forEach(m => {
                    const isOwn = m.senderId === currentUser.id; const isSystem = m.senderId === 'SYSTEM';
                    const div = document.createElement('div');
                    div.className = `message ${isOwn ? 'msg-own' : (isSystem ? 'msg-system' : 'msg-other')}`;
                    if (isSystem) { div.innerText = m.content; box.appendChild(div); return; }
                    let senderNameHtml = '';
                    if (!isOwn) { const sender = users.find(u => u.id === m.senderId) || {name: 'Unknown'}; senderNameHtml = `<div class="msg-sender-name">${sender.name}</div>`; }
                    let inner = '';
                    if (m.type === 'text') inner = `<div>${escapeHtml(m.content)}</div>`;
                    else if (m.type === 'image') inner = `<img src="${m.content}" class="msg-media">`;
                    else if (m.type === 'video-circle') inner = `<video src="${m.content}" class="video-circle" autoplay loop muted playsinline></video>`;
                    else if (m.type === 'audio') {
                        const uid = `aud_${m.id}`; const bid = `bar_${m.id}`;
                        inner = `<div class="custom-audio-player"><button class="audio-btn" data-audio="${uid}" onclick="audioPlayer.toggle(this,'${uid}')">‚ñ∂</button><div class="audio-track"><div id="${bid}" class="audio-progress"></div></div><audio id="${uid}" src="${m.content}" hidden ontimeupdate="audioPlayer.updateProgress(this,'${bid}')" onended="audioPlayer.reset(this.parentElement.querySelector('button'),'${bid}')"></audio></div>`;
                    }
                    let ticks = '';
                    if (isOwn) {
                        let colorClass = m.status === 'read' ? 'status-read' : 'status-delivered';
                        ticks = `<span class="msg-status ${colorClass}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left:-10px;"><polyline points="20 6 9 17 4 12"></polyline></svg></span>`;
                    }
                    div.innerHTML = `${senderNameHtml}${inner}<div class="msg-footer"><span class="msg-time">${new Date(m.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>${ticks}</div>`;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            },
            openSettings: () => { document.getElementById('settings-modal').style.display = 'flex'; settings.updateUI(); ui.switchTab('tab-profile'); },
            switchTab: (tabId) => {
                document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                const btnMap = {'tab-profile':0,'tab-appearance':1,'tab-data':2,'tab-lab':3,'tab-dev':4};
                const btns = document.querySelectorAll('.nav-item');
                if(btns[btnMap[tabId]]) btns[btnMap[tabId]].classList.add('active');
            },
            openNewChatModal: () => { document.getElementById('new-chat-modal').style.display = 'flex'; ui.showDefaultCreate(); const list = document.getElementById('user-list'); list.innerHTML = ''; db.getUsers().forEach(u => { if (u.id === currentUser.id) return; const div = document.createElement('div'); div.className = 'user-search-item'; div.innerHTML = `<div style="display:flex;gap:10px;align-items:center;"><img src="${u.avatar}" class="avatar-lg" style="width:40px;height:40px;"><div><b>${u.name}</b> ${u.isDev?'<span class="dev-badge">DEV</span>':''}<br><small>@${u.username}</small></div></div><button class="secondary-btn w-auto" onclick="chat.createOrGetChat('${u.id}')">Chat</button>`; list.appendChild(div); }); },
            closeModal: (id) => document.getElementById(id).style.display = 'none',
            showCallOverlay: (otherId, type, status, isGroup, chatName) => {
                const users = db.getUsers(); 
                let displayName = chatName;
                let displayAvatar = 'https://ui-avatars.com/api/?name=Group&background=random';

                if (!isGroup) {
                    const other = users.find(u => u.id === otherId);
                    displayName = other.name;
                    displayAvatar = other.avatar;
                }

                const container = document.getElementById('call-actions-container'); container.innerHTML = '';
                document.getElementById('call-overlay').style.display = 'flex';
                document.getElementById('call-target-name').innerText = displayName; 
                document.getElementById('call-target-avatar').src = displayAvatar;
                
                if (status === 'outgoing') {
                    document.getElementById('call-status').innerText = isGroup ? `–ó–≤–æ–Ω–æ–∫ –≥—Ä—É–ø–ø–µ...` : `–ò—Å—Ö–æ–¥—è—â–∏–π...`;
                    const btnEnd = document.createElement('button'); btnEnd.className = 'call-btn btn-decline'; btnEnd.innerHTML = '‚úï'; btnEnd.onclick = callSystem.endCall; container.appendChild(btnEnd);
                } else if (status === 'incoming') {
                    document.getElementById('call-status').innerText = isGroup ? `–ó–≤–æ–Ω–æ–∫ –∏–∑ –≥—Ä—É–ø–ø—ã...` : `–í—Ö–æ–¥—è—â–∏–π...`;
                    const btnDecline = document.createElement('button'); btnDecline.className = 'call-btn btn-decline'; btnDecline.innerHTML = '‚úï'; btnDecline.onclick = callSystem.endCall;
                    const btnAccept = document.createElement('button'); btnAccept.className = 'call-btn btn-accept'; btnAccept.innerHTML = 'üìû'; btnAccept.onclick = callSystem.acceptCall;
                    container.appendChild(btnDecline); container.appendChild(btnAccept);
                }
            },
            updateCallStatus: (text, connected) => {
                document.getElementById('call-status').innerText = text; const container = document.getElementById('call-actions-container');
                if (connected) { container.innerHTML = ''; const btnEnd = document.createElement('button'); btnEnd.className = 'call-btn btn-decline'; btnEnd.innerHTML = '‚úï'; btnEnd.onclick = callSystem.endCall; container.appendChild(btnEnd); }
            },
            closeCallOverlay: () => { document.getElementById('call-overlay').style.display = 'none'; }
        };

        const callSystem = {
            currentCall: null,
            startCall: (type) => {
                if (!activeChatId) return;
                const chats = db.getChats(); const chatData = chats.find(c => c.id === activeChatId);
                
                let targetId = null;
                let isGroup = chatData.isGroup;

                if (isGroup) {
                    targetId = chatData.id; // Target is the group ID
                } else {
                    targetId = chatData.participants.find(p => p !== currentUser.id);
                }

                callSystem.currentCall = { withId: targetId, type: type, status: 'outgoing', isGroup: isGroup };
                ui.showCallOverlay(targetId, type, 'outgoing', isGroup, chatData.name);
                
                // Signal broadcast
                db.sendSignal({ 
                    type: 'offer', 
                    from: currentUser.id, 
                    to: targetId, // Can be user ID or Group ID
                    callType: type,
                    isGroup: isGroup,
                    chatName: chatData.name
                });
            },
            acceptCall: () => {
                if (!callSystem.currentCall) return;
                const targetId = callSystem.currentCall.withId;
                callSystem.currentCall.status = 'connected'; ui.updateCallStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–æ', true);
                db.sendSignal({ type: 'answer', from: currentUser.id, to: targetId, isGroup: callSystem.currentCall.isGroup });
            },
            endCall: () => {
                if (!callSystem.currentCall) return;
                const targetId = callSystem.currentCall.withId;
                db.sendSignal({ type: 'end', from: currentUser.id, to: targetId, isGroup: callSystem.currentCall.isGroup });
                callSystem.currentCall = null; ui.closeCallOverlay();
            },
            handleSignal: (signal) => {
                if (!currentUser) return;
                
                // --- INCOMING CALL LOGIC ---
                let incomingMatch = false;
                
                if (signal.isGroup) {
                    const chats = db.getChats();
                    const groupChat = chats.find(c => c.id === signal.to);
                    if (groupChat && groupChat.participants.includes(currentUser.id) && signal.from !== currentUser.id) {
                        incomingMatch = true;
                    }
                } else {
                    if (signal.to === currentUser.id) {
                        incomingMatch = true;
                    }
                }

                if (signal.type === 'offer' && incomingMatch) {
                    callSystem.currentCall = { withId: signal.from, type: signal.callType, status: 'incoming', isGroup: signal.isGroup };
                    ui.showCallOverlay(signal.from, signal.callType, 'incoming', signal.isGroup, signal.chatName);
                }

                if (signal.type === 'answer') {
                    if (callSystem.currentCall && callSystem.currentCall.status === 'outgoing') {
                         if (!signal.isGroup && signal.to === currentUser.id) {
                             callSystem.currentCall.status = 'connected'; ui.updateCallStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–æ', true);
                         } else if (signal.isGroup && signal.to === callSystem.currentCall.withId) {
                             callSystem.currentCall.status = 'connected'; ui.updateCallStatus('–£—á–∞—Å—Ç–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è', true);
                         }
                    }
                }

                if (signal.type === 'end') {
                    if (!signal.isGroup && signal.to === currentUser.id) {
                        callSystem.currentCall = null; ui.closeCallOverlay();
                    }
                }
            }
        };

        const audioPlayer = {
            toggle: (btn, audioId) => {
                const audio = document.getElementById(audioId);
                document.querySelectorAll('audio').forEach(a => { if (a.id !== audioId && !a.paused) { a.pause(); a.currentTime = 0; } });
                document.querySelectorAll('.audio-btn').forEach(b => b.innerHTML = '‚ñ∂');
                if (audio.paused) { audio.play(); btn.innerHTML = '‚è∏'; } else { audio.pause(); btn.innerHTML = '‚ñ∂'; }
            },
            updateProgress: (audio, barId) => { const bar = document.getElementById(barId); if (bar && audio.duration) bar.style.width = (audio.currentTime / audio.duration) * 100 + '%'; },
            reset: (btn, barId) => { btn.innerHTML = '‚ñ∂'; const bar = document.getElementById(barId); if (bar) bar.style.width = '0%'; }
        };
        
        const devTools = {
             toggleSpy: (enabled) => { isSpyMode = enabled; ui.renderChatList(); },
             impersonate: (id) => ui.confirmAction('Impersonate?','Log in as this user?',() => { db.setSession(id, true); location.reload(); }),
             deleteUser: (id) => ui.confirmAction('Delete?','Permanent action.',() => { let users = db.getUsers().filter(u => u.id !== id); db.saveUsers(users); devTools.renderUserTable(); }),
             toggleBan: (id) => { let users = db.getUsers(); let u = users.find(x => x.id === id); if (u) { u.isBanned = !u.isBanned; db.saveUsers(users); devTools.renderUserTable(); } },
             broadcast: () => { const t = document.getElementById('broadcast-input').value; if(t) { let c=db.getChats(); c.forEach(x=>{x.messages.push({id:'sys_'+Date.now(),senderId:'SYSTEM',type:'text',content:'üì¢ SYSTEM: '+t,timestamp:Date.now(),status:'read'});x.updatedAt=Date.now();}); db.saveChats(c); notify.success('Sent broadcast'); } },
             wipe: () => { localStorage.clear(); sessionStorage.clear(); location.reload(); },
             exportDB: () => { const d={users:db.getUsers(),chats:db.getChats()}; const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='iquen_backup.json'; a.click(); },
             importDB: (i) => { const f=i.files[0]; if(!f) return; const r=new FileReader(); r.onload=(e)=>{try{const d=JSON.parse(e.target.result);if(d.users&&d.chats){db.saveUsers(d.users);db.saveChats(d.chats);notify.success('Restored!');location.reload();}}catch(err){notify.error('Invalid file');}};r.readAsText(f); },
             renderUserTable: () => {
                const tbody = document.getElementById('dev-user-list'); tbody.innerHTML = '';
                db.getUsers().forEach(u => {
                    if (u.id === currentUser.id) return;
                    const tr = document.createElement('tr'); if(u.isBanned) tr.className='banned-row';
                    tr.innerHTML = `<td>${u.name} <small>@${u.username}</small></td><td>${u.isBanned?'BAN':'OK'}</td><td><button class="dev-action-btn" style="background:#3b82f6;color:white;" onclick="devTools.impersonate('${u.id}')">Auth</button><button class="dev-action-btn" style="background:${u.isBanned?'#10b981':'#ef4444'};color:white;" onclick="devTools.toggleBan('${u.id}')">${u.isBanned?'Unban':'Ban'}</button><button class="dev-action-btn" style="color:red;" onclick="devTools.deleteUser('${u.id}')">Del</button></td>`;
                    tbody.appendChild(tr);
                });
             }
        };
        
        const effects = { flashBang: () => { const o = document.getElementById('flash-bang-overlay'); o.classList.add('flash-active'); setTimeout(() => o.classList.remove('flash-active'), 1500); } };
        function escapeHtml(text) { return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

        window.addEventListener('storage', (e) => {
            if (e.key === DB_CALL_SIGNAL) { const s = JSON.parse(e.newValue); if(s) callSystem.handleSignal(s); }
            if (!currentUser) return;
            if (e.key === DB_CHATS) { 
                const oldChats = JSON.parse(e.oldValue || '[]'); const newChats = JSON.parse(e.newValue || '[]');
                ui.renderChatList(); 
                if (activeChatId) { const c = newChats.find(x => x.id === activeChatId); if(c) ui.renderMessages(c.messages); chat.markMessagesAsRead(activeChatId); }
                newChats.forEach(nc => { const oc = oldChats.find(x => x.id === nc.id); if (oc && nc.messages.length > oc.messages.length) { const last = nc.messages[nc.messages.length-1]; if(last.senderId !== currentUser.id) soundManager.playPop(); } });
            }
            if (e.key === DB_USERS) { const me = JSON.parse(e.newValue).find(u => u.id === currentUser.id); if (me) { if(me.isBanned) { notify.error("–í–´ –ó–ê–ë–ê–ù–ï–ù–´"); auth.logout(); return; } currentUser = me; settings.apply(); } }
        });

        auth.init();
    </script>
</body>
</html>